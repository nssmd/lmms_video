# LLaVA-OneVision + 快慢帧自回归训练配置
# 使用本地 Parquet 格式的 LLaVA-Video-178K 数据集
# 集成快慢帧机制和自回归视频重建

- type: trainer
  config:
    trainer_type: hf_trainer

    # ==================== 数据集配置 ====================
    dataset_config:
      dataset_type: vision
      dataset_format: parquet  # 使用 parquet 格式

      # Parquet 文件路径（支持通配符）
      dataset_path: "/blob/LLaVA-Video-178K-parquet/*.parquet"
      
      # 视频文件基础路径（parquet 中的视频路径是相对路径，需要拼接这个基础路径）
      data_folder: "/blob/LLaVA-Video-178K"

      # 视频处理参数（使用 DatasetConfig 支持的参数）
      video_sampling_strategy: "frame_num"  # 或 "fps"
      frame_num: 16  # 采样帧数
      fps: 1  # 采样帧率（当 strategy 为 fps 时使用）
      video_backend: "decord"  # 视频解码后端

      # Processor 配置
      processor_config:
        processor_name: "llava-hf/llava-onevision-qwen2-7b-ov-hf"
        processor_type: "llava"  # 使用 llava processor (LLaVA-OneVision 兼容)
        max_pixels: 1003520
        min_pixels: 4096

      # Packing 配置
      packing: false

    # ==================== 模型配置 ====================
    model_config:
      # LLaVA-OneVision 基础模型 (使用 0.5B 版本节省显存)
      load_from_pretrained_path: "llava-hf/llava-onevision-qwen2-0.5b-ov-hf"
      attn_implementation: "flash_attention_2"

      # 所有额外配置放在 overwrite_config 中
      overwrite_config:
        # 模型配置参数
        output_hidden_states: true

        # 🔥 启用自回归重建
        enable_autoregressive: true

        # 🔥🔥 快慢帧 + 自回归配置 (LLaVA-NeXT 风格)
        autoregressive_config:
          # 基础参数
          embedding_dim: 1152
          # hidden_size 会从模型主配置自动获取，不需要在这里指定
          loss_weight: 1.0  # 1:1 权重，自回归损失与语言模型损失同等重要
          num_heads: 8
          num_layers: 3

          # LLaVA-NeXT 空间池化参数
          mm_spatial_pool_stride: 4
          mm_spatial_pool_mode: "average"
          add_faster_video: true  # 启用快帧处理

          # 快慢帧类型分配策略
          frame_sampling_strategy: "interleave"  # interleave/periodic/uniform
          slow_frame_ratio: 0.25  # 慢帧比例 (0.25 = 每4帧一个慢帧)

    # ==================== 训练参数 ====================
    output_dir: "./output/llava_ov_fast_slow_autoregressive"
    run_name: "llava_ov_fast_slow_ar"

    num_train_epochs: 3
    per_device_train_batch_size: 2
    per_device_eval_batch_size: 1
    gradient_accumulation_steps: 8

    learning_rate: 2.0e-5
    weight_decay: 0.01
    warmup_ratio: 0.03
    lr_scheduler_type: "cosine"
    optim: "adamw_torch"

    bf16: true
    tf32: true
    fp16: false

    max_grad_norm: 1.0
    gradient_checkpointing: true

    # ==================== DeepSpeed 配置 ====================
    deepspeed: "./configs/deepspeed_zero3.json"

    # ==================== 日志和保存 ====================
    logging_steps: 10
    save_strategy: "steps"
    save_steps: 500
    save_total_limit: 3
    eval_strategy: "no"

    logging_dir: "./logs"
    report_to: ["tensorboard"]
    logging_first_step: true

    # ==================== 数据加载 ====================
    dataloader_num_workers: 4
    dataloader_pin_memory: true
    remove_unused_columns: false
    dataloader_persistent_workers: true

    # ==================== 其他 ====================
    seed: 42
    ddp_find_unused_parameters: true